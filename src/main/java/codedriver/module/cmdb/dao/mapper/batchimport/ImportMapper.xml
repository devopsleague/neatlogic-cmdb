<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright(c) 2021 TechSure Co., Ltd. All Rights Reserved.
  ~ 本内容仅限于深圳市赞悦科技有限公司内部传阅，禁止外泄以及用于其他的商业项目。
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.module.cmdb.dao.mapper.batchimport.ImportMapper">

    <select id="getCmdbImportFileList" resultType="codedriver.framework.file.dto.FileVo"
            parameterType="java.lang.String">
        SELECT
        b.`id`,
        b.`name`,
        b.`path`,
        b.`size`
        FROM
        `cmdb_import_file` a JOIN `file` b ON a.`file_id` = b.`id`
        <where>
            <if test="value != null and value != ''">
                AND b.`user_uuid` = #{VALUE}
            </if>
        </where>
    </select>

    <sql id="searchImportAuditCondition">
        <where>
            <if test="ciId != null">
                and `ci_id` = #{ciId}
            </if>
            <if test="importUser != null and importUser != ''">
                and `import_user` = #{importUser}
            </if>
            <if test="idList != null and idList.size() > 0">
                and id IN
                <foreach collection="idList" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
    </sql>

    <select id="searchImportAuditCount" parameterType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo"
            resultType="int">
        SELECT
        COUNT(1)
        FROM `cmdb_import_audit` a
        <include refid="searchImportAuditCondition"></include>
    </select>

    <select id="searchImportAudit" parameterType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo"
            resultType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo">
        SELECT `id`,
        `import_user` as importUser,
        (select `user_name` from `user` where `uuid` = a.`import_user`) as `importUserName`,
        `import_date` as `importDate`,
        `finish_date` as `finishDate`,
        (select `label` from `cmdb_ci` where `id` = a.`ci_id`) as `ciName`,
        `action`,
        `success_count` as `successCount`,
        `failed_count` as `failedCount`,
        `status`,
        `error`
        FROM `cmdb_import_audit` a
        <include refid="searchImportAuditCondition"></include>
        order by id desc
        <if test="needPage">
            limit #{startNum}, #{pageSize}
        </if>
    </select>

    <select id="getImportAuditById" parameterType="java.lang.Long"
            resultType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo">
        select `id`,
               (select `user_name` from `user` where `uuid` = a.`import_user`) as `importUserName`,
               `import_date`,
               `finish_date`,
               (select `label` from `cmdb_ci` where `id` = a.`ci_id`)          as `ciName`,
               `action`,
               `success_count`                                                 as `successCount`,
               `failed_count`                                                  as `failedCount`,
               `status`,
               `error`
        FROM `cmdb_import_audit` a
        WHERE `id` = #{value}
    </select>

    <update id="updateImportAudit" parameterType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo">
        UPDATE `cmdb_import_audit`
        SET `finish_date`   = NOW(3),
            `success_count` = #{successCount},
            `failed_count`  = #{failedCount},
            `total_count`   = #{totalCount},
            `status`        = #{status},
            `error`         = #{error,typeHandler=CompressHandler}
        WHERE `id` = #{id}
    </update>

    <update id="updateImportAuditTemporary" parameterType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo">
        UPDATE `cmdb_import_audit`
        SET `success_count` = #{successCount},
            `failed_count`  = #{failedCount},
            `total_count`   = #{totalCount},
            `error`         = #{error,typeHandler=CompressHandler}
        WHERE `id` = #{id}
    </update>

    <update id="updateImportAuditStatus" parameterType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo">
        UPDATE cmdb_import_audit
        SET `finish_date` = NOW(3),
            `status`      = #{status},
            `error`       = #{error,typeHandler=CompressHandler}
        WHERE `id` = #{id}
    </update>

    <insert id="insertCmdbImportFile" parameterType="codedriver.framework.file.dto.FileVo">
        INSERT INTO `cmdb_import_file` (`file_id`)
        VALUES (#{id})
    </insert>

    <insert id="insertImportAudit" parameterType="codedriver.framework.cmdb.dto.batchimport.ImportAuditVo">
        INSERT INTO cmdb_import_audit
        (`id`,
         `import_user`,
         `import_date`,
         `action`,
         `file_id`,
         `ci_id`,
         `status`,
         `server_id`)
        VALUES (#{id},
                #{importUser},
                NOW(3),
                #{action},
                #{fileId},
                #{ciId},
                #{status},
                #{serverId})
    </insert>

    <delete id="deleteCmdbImportFile" parameterType="java.lang.Long">
        DELETE
        FROM `cmdb_import_file`
        WHERE `file_id` = #{value}
    </delete>

</mapper>
