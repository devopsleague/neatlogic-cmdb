<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright(c) 2022 TechSure Co., Ltd. All Rights Reserved.
  ~ 本内容仅限于深圳市赞悦科技有限公司内部传阅，禁止外泄以及用于其他的商业项目。
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.module.cmdb.dao.mapper.resourcecenter.ResourceMapper">

    <sql id="resource_ipobject_where">
        <if test="typeIdList != null and typeIdList.size() > 0">
            AND a.`type_id` IN
            <foreach collection="typeIdList" item="typeId" open="(" separator="," close=")">
                #{typeId}
            </foreach>
        </if>
        <if test="stateIdList != null and stateIdList.size() > 0">
            AND a.`state_id` IN
            <foreach collection="stateIdList" item="stateId" open="(" separator="," close=")">
                #{stateId}
            </foreach>
        </if>
        <if test="envIdList != null and envIdList.size() > 0">
            AND a.`env_id` IN
            <foreach collection="envIdList" item="envId" open="(" separator="," close=")">
                #{envId}
            </foreach>
        </if>
        <if test="appSystemIdList != null and appSystemIdList.size() > 0">
            AND a.`app_system_id` IN
            <foreach collection="appSystemIdList" item="appSystemId" open="(" separator="," close=")">
                #{appSystemId}
            </foreach>
        </if>
        <if test="appModuleIdList != null and appModuleIdList.size() > 0">
            AND a.`app_module_id` IN
            <foreach collection="appModuleIdList" item="appModuleId" open="(" separator="," close=")">
                #{appModuleId}
            </foreach>
        </if>
        <if test="defaultValue != null and defaultValue.size() > 0">
            AND a.`id` IN
            <foreach collection="defaultValue" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="inspectStatusList != null and inspectStatusList.size() > 0">
            AND a.`inspect_status` IN
            <foreach collection="inspectStatusList" item="inspectStatus" open="(" separator="," close=")">
                #{inspectStatus}
            </foreach>
        </if>
        <if test="protocolIdList != null and protocolIdList.size() > 0">
            AND c.`protocol_id` IN
            <foreach collection="protocolIdList" item="protocolId" open="(" separator="," close=")">
                #{protocolId}
            </foreach>
        </if>
        <if test="tagIdList != null and tagIdList.size() > 0">
            AND d.`tag_id` IN
            <foreach collection="tagIdList" item="tagId" open="(" separator="," close=")">
                #{tagId}
            </foreach>
        </if>
    </sql>

    <select id="getResourceCountByNameKeyword"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`scence_ipobject_detail` a
        LEFT JOIN `cmdb_resourcecenter_resource_account` b ON b.`resource_id` = a.`id`
        LEFT JOIN `cmdb_resourcecenter_account` c ON c.`id` = b.`account_id`
        LEFT JOIN `cmdb_resourcecenter_resource_tag` d ON d.`resource_id` = a.`id`
        WHERE a.`name` LIKE CONCAT('%', #{keyword}, '%')
        <include refid="resource_ipobject_where"/>
    </select>

    <select id="getResourceCountByIpKeyword"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`scence_ipobject_detail` a
        LEFT JOIN `cmdb_resourcecenter_resource_account` b ON b.`resource_id` = a.`id`
        LEFT JOIN `cmdb_resourcecenter_account` c ON c.`id` = b.`account_id`
        LEFT JOIN `cmdb_resourcecenter_resource_tag` d ON d.`resource_id` = a.`id`
        WHERE a.`ip` LIKE CONCAT('%', #{keyword}, '%')
        <include refid="resource_ipobject_where"/>
    </select>

    <select id="getResourceCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`scence_ipobject_detail` a
        LEFT JOIN `cmdb_resourcecenter_resource_account` b ON b.`resource_id` = a.`id`
        LEFT JOIN `cmdb_resourcecenter_account` c ON c.`id` = b.`account_id`
        LEFT JOIN `cmdb_resourcecenter_resource_tag` d ON d.`resource_id` = a.`id`
        <where>
            <if test="keyword != null and keyword != ''">
                AND (a.`name` LIKE CONCAT('%', #{keyword}, '%') OR a.`ip` LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <include refid="resource_ipobject_where"/>
        </where>
    </select>

    <select id="getResourceIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT m.`id` FROM (
        SELECT DISTINCT a.`id`, a.`name`, a.`ip`
        FROM ${schemaName}.`scence_ipobject_detail` a
        LEFT JOIN `cmdb_resourcecenter_resource_account` b ON b.`resource_id` = a.`id`
        LEFT JOIN `cmdb_resourcecenter_account` c ON c.`id` = b.`account_id`
        LEFT JOIN `cmdb_resourcecenter_resource_tag` d ON d.`resource_id` = a.`id`
        <where>
            <if test="keyword != null and keyword != ''">
                AND (a.`name` LIKE CONCAT('%', #{keyword}, '%') OR a.`ip` LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <include refid="resource_ipobject_where"/>
        </where>
        <choose>
            <when test="isNameFieldSort != null and isNameFieldSort == 1">
                ORDER BY LENGTH(a.`name`)
            </when>
            <when test="isIpFieldSort != null and isIpFieldSort == 1">
                ORDER BY LENGTH(a.`ip`)
            </when>
            <otherwise>
                ORDER BY a.`id`
            </otherwise>
        </choose>
        LIMIT #{startNum}, #{pageSize}
        ) m
    </select>

    <resultMap id="resourceCenterMap" type="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="abbr_name" property="abbrName"/>
        <result column="type_id" property="typeId"/>
        <result column="type_name" property="typeName"/>
        <result column="type_label" property="typeLabel"/>
        <result column="inspect_status" property="inspectStatus"/>
        <result column="inspect_time" property="inspectTime"/>
        <result column="monitor_status" property="monitorStatus"/>
        <result column="monitor_time" property="monitorTime"/>
        <result column="maintenance_window" property="maintenanceWindow"/>
        <result column="description" property="description"/>
        <result column="fcu" property="fcu"/>
        <result column="fcd" property="fcd"/>
        <result column="lcu" property="lcu"/>
        <result column="lcd" property="lcd"/>
        <result column="network_area" property="networkArea"/>
        <result column="port" property="port"/>
        <result column="ip" property="ip"/>
        <result column="state_id" property="stateId"/>
        <result column="state_name" property="stateName"/>
        <result column="state_label" property="stateLabel"/>
        <result column="datacenter_id" property="dataCenterId"/>
        <result column="datacenter_name" property="dataCenterName"/>
        <result column="env_id" property="envId"/>
        <result column="env_name" property="envName"/>
        <result column="app_module_id" property="appModuleId"/>
        <result column="app_module_name" property="appModuleName"/>
        <result column="app_module_abbr_name" property="appModuleAbbrName"/>
        <result column="app_system_id" property="appSystemId"/>
        <result column="app_system_name" property="appSystemName"/>
        <result column="app_system_abbr_name" property="appSystemAbbrName"/>
        <result column="cluster_id" property="clusterId"/>
        <result column="cluster_name" property="clusterName"/>
        <result column="cluster_type_id" property="clusterTypeId"/>
        <collection property="bgList" ofType="codedriver.framework.cmdb.dto.resourcecenter.BgVo">
            <id column="bg_id" property="bgId"/>
            <result column="bg_name" property="bgName"/>
        </collection>
        <collection property="ownerList" ofType="codedriver.framework.cmdb.dto.resourcecenter.OwnerVo">
            <id column="user_id" property="userId"/>
            <result column="user_uuid" property="uuid"/>
            <result column="user_name" property="userName"/>
        </collection>
        <collection property="allIp" ofType="codedriver.framework.cmdb.dto.resourcecenter.IpVo">
            <id column="allip_id" property="id"/>
            <result column="allip_ip" property="ip"/>
            <result column="allip_label" property="label"/>
        </collection>
    </resultMap>

    <select id="getResourceListByIdList" resultMap="resourceCenterMap">
        SELECT
        a.`id`,
        a.`ip`,
        a.`port`,
        a.`type_id`,
        a.`type_name`,
        a.`type_label`,
        a.`name`,
        a.`monitor_status`,
        a.`monitor_time`,
        a.`inspect_status`,
        a.`inspect_time`,
        a.`network_area`,
        a.`maintenance_window`,
        a.`description`,
        a.`app_module_id`,
        a.`app_module_name`,
        a.`app_module_abbr_name`,
        a.`app_system_id`,
        a.`app_system_name`,
        a.`app_system_abbr_name`,
        a.`allip_id`,
        a.`allip_ip`,
        a.`allip_label`,
        a.`bg_id`,
        a.`bg_name`,
        a.`user_id`,
        a.`user_uuid`,
        a.`user_name`,
        a.`state_id`,
        a.`state_name`,
        a.`state_label`,
        a.`env_id`,
        a.`env_name`
        FROM ${schemaName}.`scence_ipobject_detail` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getIpObjectResourceCountByAppModuleIdAndTypeIdAndEnvIdAndTypeId"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="int">
        SELECT COUNT(1)
        FROM ${schemaName}.`scence_ipobject_env_appmodule` a
        WHERE a.`type_id` = #{typeId}
        AND a.`app_module_id` = #{appModuleId}
        <if test="envId != null">
            AND a.`env_id` = #{envId}
        </if>
    </select>

    <select id="getIpObjectResourceIdListByAppModuleIdAndTypeIdAndEnvIdAndTypeId"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`scence_ipobject_env_appmodule` a
        WHERE a.`type_id` = #{typeId}
        AND a.`app_module_id` = #{appModuleId}
        <if test="envId != null">
            AND a.`env_id` = #{envId}
        </if>
        ORDER BY a.`id` DESC
        LIMIT #{startNum}, #{pageSize}
    </select>

    <sql id="getAppInstanceResourceListByIdList">
        SELECT
        a.`id`,
        a.`ip`,
        a.`port`,
        a.`name`,
        a.`type_id`,
        a.`monitor_status`,
        a.`monitor_time`,
        a.`inspect_status`,
        a.`inspect_time`,
        a.`network_area`,
        a.`maintenance_window`,
        a.`description`,
        a.`bg_id`,
        a.`bg_name`,
        a.`user_id`,
        a.`user_uuid`,
        a.`user_name`,
        a.`state_id`,
        a.`state_name`,
        a.`state_label`,
        a.`env_id`,
        a.`env_name`,
        a.`datacenter_id`,
        a.`datacenter_name`,
        a.`cluster_id`,
        a.`cluster_type_id`,
        a.`cluster_name`
        FROM ${schemaName}.`scence_appinstance_detail_cluster` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </sql>

    <select id="getAppInstanceResourceListByIdList" resultMap="resourceCenterMap">
        <include refid="getAppInstanceResourceListByIdList"/>
    </select>

    <select id="getAppInstanceResourceListByIdListAndKeyword" resultMap="resourceCenterMap">
        <include refid="getAppInstanceResourceListByIdList"/>
        <if test="keyword != null and keyword != ''">
            and (a.`ip` like CONCAT('%', #{keyword}, '%') or a.`name` like CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <select id="getAppInstanceResourceListByIdListSimple" resultMap="resourceCenterMap">
        SELECT
        a.`id`,
        a.`ip`,
        a.`port`,
        a.`name`,
        a.`type_id`,
        a.`monitor_status`,
        a.`monitor_time`,
        a.`inspect_status`,
        a.`inspect_time`,
        a.`network_area`,
        a.`maintenance_window`,
        a.`description`,
        a.`bg_id`,
        a.`bg_name`,
        a.`user_id`,
        a.`user_uuid`,
        a.`user_name`,
        a.`state_id`,
        a.`state_name`,
        a.`state_label`,
        a.`env_id`,
        a.`env_name`
        FROM ${schemaName}.`scence_ipobject_detail` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getDbInstanceResourceListByIdList" resultMap="resourceCenterMap">
        SELECT
        a.`id`,
        a.`ip`,
        a.`port`,
        a.`name`,
        a.`type_id`,
        a.`monitor_status`,
        a.`monitor_time`,
        a.`inspect_status`,
        a.`inspect_time`,
        a.`network_area`,
        a.`maintenance_window`,
        a.`description`,
        a.`bg_id`,
        a.`bg_name`,
        a.`user_id`,
        a.`user_uuid`,
        a.`user_name`,
        a.`state_id`,
        a.`state_name`,
        a.`state_label`,
        a.`env_id`,
        a.`env_name`,
        a.`datacenter_id`,
        a.`datacenter_name`,
        a.`cluster_id`,
        a.`cluster_type_id`,
        a.`cluster_name`
        FROM ${schemaName}.`scence_dbinstance_detail_cluster` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getResourceIdByIpAndPortAndName"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`scence_ipobject_ip_port` a
        WHERE a.`ip` = #{ip}
        <choose>
            <when test="port != null and port != ''">
                AND a.`port` = #{port}
            </when>
            <otherwise>
                AND a.`port` is null
            </otherwise>
        </choose>
        <if test="name != null and name != ''">
            and a.`name` = #{name}
        </if>
        LIMIT 1
    </select>

    <select id="getResourceByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`ip`,a.`type_id`, a.`type_name`
        FROM ${schemaName}.`scence_ipobject_ip_port` a
        where a.`id` in
        <foreach collection="idList" item="id" separator="," close=")" open="(">
            #{id}
        </foreach>
    </select>

    <select id="getResourceById" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`ip`, a.`port`, a.`type_id`, a.`type_name`
        FROM ${schemaName}.`scence_ipobject_ip_port` a
        where a.`id` = #{id}
    </select>

    <select id="getResourceFromSoftwareServiceByIdList" resultMap="resourceCenterMap">
        SELECT a.`id`, a.`name`, a.`ip`, a.`port`,a.`type_id`, a.`type_name`
        FROM ${schemaName}.`scence_softwareservice_ip_port` a
        where a.`id` in
        <foreach collection="idList" item="id" separator="," close=")" open="(">
            #{id}
        </foreach>
    </select>

    <select id="checkResourceIsExists" resultType="int">
        SELECT COUNT(DISTINCT a.`id`)
        FROM ${schemaName}.`scence_ipobject_id` a
        where a.`id` = #{id}
    </select>

    <select id="checkResourceIdListIsExists" resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`scence_ipobject_id` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getHasModuleAppSystemIdListByAppSystemIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT `id` FROM `scence_appsystem_appmodule`
        WHERE `app_module_id` IS NOT NULL
        AND `id` IN
        <foreach collection="appSystemIdList" item="appSystemId" open="(" separator="," close=")">
            #{appSystemId}
        </foreach>
    </select>

    <select id="getHasEnvAppSystemIdListByAppSystemIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT a.`app_system_id`
        FROM `scence_ipobject_env_appmodule_appsystem` a
        WHERE a.env_id IS NOT NULL
        AND a.`app_module_id` IS NOT NULL
        AND a.`app_system_id` IN
        <foreach collection="appSystemIdList" item="appSystemId" open="(" separator="," close=")">
            #{appSystemId}
        </foreach>
    </select>

    <select id="searchAppModuleCount" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT a.`app_module_id`)
        FROM ${schemaName}.`scence_appsystem_appmodule` a
        WHERE a.`app_module_id` IS NOT NULL
        <if test="keyword != null and keyword != ''">
            AND a.`app_module_name` LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="appSystemIdList != null and appSystemIdList.size() > 0">
            AND a.`id` IN
            <foreach collection="appSystemIdList" item="appSystemId" open="(" separator="," close=")">
                #{appSystemId}
            </foreach>
        </if>
    </select>

    <select id="searchAppModuleIdList" parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="java.lang.Long">
        SELECT DISTINCT a.`app_module_id`
        FROM ${schemaName}.`scence_appsystem_appmodule` a
        WHERE a.`app_module_id` IS NOT NULL
        <if test="keyword != null and keyword != ''">
            AND a.`app_module_name` LIKE CONCAT('%', #{keyword}, '%')
        </if>
        <if test="appSystemIdList != null and appSystemIdList.size() > 0">
            AND a.`id` IN
            <foreach collection="appSystemIdList" item="appSystemId" open="(" separator="," close=")">
                #{appSystemId}
            </foreach>
        </if>
        ORDER BY a.`app_module_id` DESC
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="searchAppModule"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultMap="resourceCenterMap">
        SELECT
        a.`id`,
        a.`name`,
        a.`abbr_name`,
        a.`maintenance_window`,
        a.`description`,
        a.`inspect_status`,
        a.`inspect_time`,
        a.`monitor_status`,
        a.`monitor_time`,
        a.`fcu`,
        a.`fcd`,
        a.`lcu`,
        a.`lcd`,
        a.`app_system_id`,
        a.`app_system_name`,
        a.`app_system_abbr_name`,
        a.`bg_id`,
        a.`bg_name`,
        a.`user_id`,
        a.`user_uuid`,
        a.`user_name`
        FROM ${schemaName}.`scence_appmodule_appsystem` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY a.`id` DESC
    </select>

    <select id="getAppSystemModuleIdListByAppSystemId"
            resultType="java.lang.Long">
        SELECT `app_module_id`
        FROM `scence_appsystem_appmodule`
        WHERE `id` = #{appSystemId}
    </select>

    <select id="getAppSystemModuleIdListByAppSystemIdAndAppModuleIdList"
            resultType="java.lang.Long">
        SELECT `app_module_id` FROM @{DATA_SCHEMA}.`scence_appsystem_appmodule`
        <where>
            <if test="appSystemId != null">
                And `id` = #{appSystemId}
            </if>
            <if test="appModuleIdList != null and appModuleIdList.size() > 0">
                And app_module_id in
                <foreach collection="appModuleIdList" open="(" separator="," close=")" item="moduleId">
                    #{moduleId}
                </foreach>
            </if>
        </where>
    </select>

    <select id="getAppModuleListByAppSystemIdList"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.entity.ModuleVo">
        SELECT
        `id` AS resourceId,
        `app_module_id` AS appModuleId,
        `app_module_name` AS appModuleName,
        `app_module_abbr_name` AS appModuleAbbrName
        FROM ${schemaName}.`scence_appsystem_appmodule`
        <where>
            and `app_module_id` IS NOT NULL
            and `id` IN
            <foreach collection="appSystemIdList" item="appSystemId" open="(" separator="," close=")">
                #{appSystemId}
            </foreach>
        </where>
    </select>

    <select id="getAppModuleListByIdListSimple" resultMap="resourceCenterMap">
        SELECT
        a.`id`, a.`name`, a.`abbr_name`, a.`maintenance_window`, a.`description`,
        a.`inspect_status`, a.`inspect_time`, a.`monitor_status`, a.`monitor_time`,
        a.`fcu`, a.`fcd`, a.`lcu`, a.`lcd`
        FROM @{DATA_SCHEMA}.`scence_appmodule` a
        WHERE a.`id` IN
        <foreach collection="idList" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        <if test="needOrder != null and needOrder == true">
            order by CONVERT(a.abbr_name USING gbk) COLLATE gbk_chinese_ci ASC
        </if>
    </select>

    <select id="getIpObjectResourceTypeIdListByAppModuleIdAndEnvId"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT a.`type_id`
        FROM ${schemaName}.`scence_ipobject_env_appmodule` a
        WHERE a.`app_module_id` = #{appModuleId}
        <if test="envId != null">
            AND a.`env_id` = #{envId}
        </if>
    </select>

    <select id="getResourceListByResourceVoList" resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        SELECT a.name,a.`ip`,a.id,a.port,a.type_name as typeName
        FROM ${schemaName}.`scence_ipobject_ip_port` a
        WHERE
        <foreach collection="resourceList" item="resource" separator="or" open="(" close=")">
            a.ip = #{resource.ip}
            <if test="resource.port != null">
                and a.port = #{resource.port}
            </if>
            <if test="resource.port == null">
                and a.port is null
            </if>
            <if test="resource.name != null">
                and a.name = #{resource.name}
            </if>
        </foreach>
    </select>

    <select id="getResourceIdListByAppSystemIdAndModuleIdAndEnvId"
            resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`scence_ipobject_env_appmodule_appsystem` a
        WHERE a.`app_system_id` = #{resourceVo.appSystemId}
          AND a.`app_module_id` = #{resourceVo.appModuleId}
          AND a.`env_id` = #{resourceVo.envId}
        ORDER BY a.`id` DESC
        LIMIT #{resourceVo.startNum}, #{resourceVo.pageSize}
    </select>

    <select id="getAppInstanceResourceIdListByAppSystemIdAndModuleIdAndEnvId"
            resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`scence_appinstance_env_appmodule_appsystem` a
        <where>
            <choose>
                <when test="resourceVo.appSystemId != null">
                    AND a.`app_system_id` = #{resourceVo.appSystemId}
                </when>
                <otherwise>
                    AND a.`app_system_id` IS NOT NULL
                </otherwise>
            </choose>
            <choose>
                <when test="resourceVo.appModuleId != null">
                    AND a.`app_module_id` = #{resourceVo.appModuleId}
                </when>
                <otherwise>
                    AND a.`app_module_id` IS NOT NULL
                </otherwise>
            </choose>
            <choose>
                <when test="resourceVo.envId != null">
                    AND a.`env_id` = #{resourceVo.envId}
                </when>
                <otherwise>
                    AND a.`env_id` IS NOT NULL
                </otherwise>
            </choose>
        </where>
        ORDER BY a.`id` DESC
        <if test="resourceVo.needPage">
            LIMIT #{resourceVo.startNum}, #{resourceVo.pageSize}
        </if>
    </select>

    <select id="getResourceIdByIpAndPortAndNameWithFilter"
            parameterType="codedriver.framework.cmdb.dto.resourcecenter.ResourceSearchVo" resultType="java.lang.Long">
        SELECT a.`id`
        FROM ${schemaName}.`scence_ipobject_detail` a
        LEFT JOIN `cmdb_resourcecenter_resource_account` b ON b.`resource_id` = a.`id`
        LEFT JOIN `cmdb_resourcecenter_account` c ON c.`id` = b.`account_id`
        LEFT JOIN `cmdb_resourcecenter_resource_tag` d ON d.`resource_id` = a.`id`
        WHERE a.`ip` = #{ip}
        <if test="keyword != null and keyword != ''">
            AND (a.`name` LIKE CONCAT('%', #{keyword}, '%') OR a.`ip` LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        <include refid="resource_ipobject_where"/>
        <choose>
            <when test="port != null and port != ''">
                AND a.`port` = #{port}
            </when>
            <otherwise>
                AND a.`port` is null
            </otherwise>
        </choose>
        <if test="name != null and name != ''">
            and a.`name` = #{name}
        </if>
        limit 1
    </select>

    <select id="getResourceListByTypeIdListAndIpList"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        SELECT a.`id`, a.`ip`, a.`name`
        FROM ${schemaName}.`scence_ipobject_ip_port` a
        WHERE a.`type_id` IN
        <foreach collection="typeIdList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        AND a.`ip` IN
        <foreach collection="ipList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="getResourceByIpAndPortAndNameAndTypeName"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        SELECT
        a.`name`,
        a.`ip`,
        a.id,
        a.`port`,
        a.`type_name` AS typeName
        FROM
        ${schemaName}.`scence_ipobject_ip_port` a
        WHERE
        a.`ip` = #{ip}
        <if test="typeName != null and typeName != ''">
            and a.`type_name` = #{typeName}
        </if>
        <if test="port != null">
            and a.`port` = #{port}
        </if>
        <if test="port == null">
            and a.`port` is null
        </if>
        <if test="name != null and name != ''">
            and a.`name` = #{name}
        </if>
    </select>

    <select id="getResourceByIpAndPort"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        SELECT
        a.`name`,
        a.`ip`,
        a.`id`,
        a.`port`,
        a.`type_name` AS typeName
        FROM
        ${schemaName}.`scence_ipobject_ip_port` a
        WHERE
        a.`ip` = #{ip}
        <if test="port != null">
            and a.`port` = #{port}
        </if>
        <if test="port == null">
            and a.`port` is null
        </if>
    </select>

    <select id="getAppSystemById" resultMap="resourceCenterMap">
        select `id`,
               `name`,
               `abbr_name`,
               `type_id`,
               `type_name`,
               `type_label`,
               `fcu`,
               `fcd`,
               `lcu`,
               `lcd`,
               `maintenance_window`,
               `description`,
               `inspect_status`,
               `inspect_time`,
               `monitor_status`,
               `monitor_time`
        from `${schemaName}`.`scence_appsystem`
        where `id` = #{id}
    </select>

    <select id="getAppModuleById" resultMap="resourceCenterMap">
        select `id`,
               `name`,
               `abbr_name`,
               `fcu`,
               `fcd`,
               `lcu`,
               `lcd`,
               `maintenance_window`,
               `description`,
               `inspect_status`,
               `inspect_time`,
               `monitor_status`,
               `monitor_time`
        from `${schemaName}`.`scence_appmodule`
        where `id` = #{id}
    </select>

    <select id="getAppEnvById" resultMap="resourceCenterMap">
        select `id`,
               `name`,
               `description`
        from `${schemaName}`.`scence_env`
        where `id` = #{id}
    </select>

    <select id="searchAccountComponent" resultType="codedriver.framework.cmdb.dto.resourcecenter.AccountComponentVo">
        SELECT
        a.id as id,
        a.name as name,
        a.ip as ip,
        b.id as accountId,
        b.name as accountName,
        b.account as account,
        d.id as protocolId,
        d.name as protocol,
        d.port as port
        FROM `cmdb_resourcecenter_resource_account` c
        JOIN ${schemaName}.`scence_ipobject_ip_port` a ON a.id = c.resource_id
        JOIN `cmdb_resourcecenter_account` b ON b.id = c.account_id
        JOIN `cmdb_resourcecenter_account_protocol` d ON d.id = b.protocol_id
        <where>
            <if test="accountComponentVo.keyword != null and accountComponentVo.keyword != ''">
                a.`name` like concat('%', #{accountComponentVo.keyword}, '%') or a.`ip` =#{accountComponentVo.keyword}
            </if>
        </where>
        LIMIT #{accountComponentVo.startNum}, #{accountComponentVo.pageSize}
    </select>

    <select id="searchAccountComponentCount" resultType="int">
        SELECT
        count(DISTINCT a.id)
        FROM `cmdb_resourcecenter_resource_account` c
        JOIN ${schemaName}.`scence_ipobject_ip_port` a ON a.id = c.resource_id
        JOIN `cmdb_resourcecenter_account` b ON b.id = c.account_id
        JOIN `cmdb_resourcecenter_account_protocol` d ON d.id = b.protocol_id
        <where>
            <if test="accountComponentVo.keyword != null and accountComponentVo.keyword != ''">
                a.`name` like concat('%', #{accountComponentVo.keyword}, '%') or a.`ip` =#{accountComponentVo.keyword}
            </if>
        </where>
    </select>

    <select id="getAppSystemByName" resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        select `id`,
               `name`,
               `abbr_name`,
               `type_id`,
               `type_name`,
               `type_label`,
               `fcu`,
               `fcd`,
               `lcu`,
               `lcd`,
               `maintenance_window`,
               `description`,
               `inspect_status`,
               `inspect_time`,
               `monitor_status`,
               `monitor_time`
        from `${schemaName}`.`scence_appsystem`
        where `abbr_name` = #{name}
    </select>

    <select id="getAppModuleByName" resultType="codedriver.framework.cmdb.dto.resourcecenter.ResourceVo">
        select `id`,
               `name`,
               `abbr_name`,
               `fcu`,
               `fcd`,
               `lcu`,
               `lcd`,
               `maintenance_window`,
               `description`,
               `inspect_status`,
               `inspect_time`,
               `monitor_status`,
               `monitor_time`
        from `${schemaName}`.`scence_appmodule`
        where `abbr_name` = #{name}
    </select>

    <select id="getAppEnvByName" resultMap="resourceCenterMap">
        select `id`,
               `name`,
               `description`
        from `${schemaName}`.`scence_env`
        where `name` = #{name}
    </select>

    <select id="getAllAppEnv"
            resultType="codedriver.framework.cmdb.dto.resourcecenter.entity.AppEnvironmentVo">
        select `id`         as envId,
               `name`       as envName,
               `env_seq_no` as envSeqNo
        from `${schemaName}`.`scence_env`
    </select>

    <select id="searchAppEnvCount" parameterType="codedriver.framework.common.dto.BasePageVo" resultType="int">
        SELECT
        COUNT(1)
        FROM `scence_env`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` LIKE CONCAT('%', #{keyword}, '%')
                OR `description` LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="searchAppEnvIdList" parameterType="codedriver.framework.common.dto.BasePageVo"
            resultType="java.lang.Long">
        SELECT
        `id`
        FROM `scence_env`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` LIKE CONCAT('%', #{keyword}, '%')
                OR `description` LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="searchAppEnvListByIdList" parameterType="java.lang.Long" resultMap="resourceCenterMap">
        SELECT
        `id`,
        `name`,
        `description`,
        `env_seq_no`
        FROM `scence_env`
        WHERE `id` IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="searchAppSystemCount" parameterType="codedriver.framework.common.dto.BasePageVo" resultType="int">
        SELECT
        COUNT(1)
        FROM `scence_appsystem`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` LIKE CONCAT('%', #{keyword}, '%')
                OR `abbr_name` LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="searchAppSystemIdList" parameterType="codedriver.framework.common.dto.BasePageVo"
            resultType="java.lang.Long">
        SELECT
        `id`
        FROM `scence_appsystem`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` LIKE CONCAT('%', #{keyword}, '%')
                OR `abbr_name` LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="searchAppSystemListByIdList" parameterType="java.lang.Long" resultMap="resourceCenterMap">
        SELECT
        `id`,
        `name`,
        `abbr_name`,
        `type_id`,
        `type_name`,
        `type_label`,
        `fcu`,
        `fcd`,
        `lcu`,
        `lcd`,
        `maintenance_window`,
        `description`,
        `inspect_status`,
        `inspect_time`,
        `monitor_status`,
        `monitor_time`
        FROM `scence_appsystem`
        WHERE `id` IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="searchStateCount" parameterType="codedriver.framework.common.dto.BasePageVo" resultType="int">
        SELECT
        COUNT(1)
        FROM `scence_state`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` LIKE CONCAT('%', #{keyword}, '%')
                OR `description` LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
    </select>

    <select id="searchStateIdList" parameterType="codedriver.framework.common.dto.BasePageVo"
            resultType="java.lang.Long">
        SELECT
        `id`
        FROM `scence_state`
        <where>
            <if test="keyword != null and keyword != ''">
                `name` LIKE CONCAT('%', #{keyword}, '%')
                OR `description` LIKE CONCAT('%', #{keyword}, '%')
            </if>
        </where>
        LIMIT #{startNum}, #{pageSize}
    </select>

    <select id="searchStateListByIdList" parameterType="java.lang.Long" resultMap="resourceCenterMap">
        SELECT
        `id`,
        `name`,
        `description`
        FROM `scence_state`
        WHERE `id` IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
</mapper>
