<?xml version="1.0" encoding="UTF-8" ?>
<!--
  ~ Copyright(c) 2021 TechSure Co., Ltd. All Rights Reserved.
  ~ 本内容仅限于深圳市赞悦科技有限公司内部传阅，禁止外泄以及用于其他的商业项目。
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.module.cmdb.dao.mapper.transaction.TransactionMapper">
    <select id="getCiEntityTransactionByTransactionIdList"
            resultType="codedriver.framework.cmdb.dto.transaction.CiEntityTransactionVo">
        SELECT
        `id`,
        `ci_id` AS ciId,
        `ci_entity_id` AS ciEntityId,
        `name` AS name,
        `action`,
        `transaction_id` AS transactionId,
        `snapshot` AS snapshot,
        `content` AS content,
        `edit_mode` AS editMode
        FROM
        `cmdb_cientity_transaction`
        WHERE ci_entity_id = #{ciEntityId} AND transaction_id IN
        <foreach collection="transactionIdList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <update id="updateCiEntityTransactionContent"
            parameterType="codedriver.framework.cmdb.dto.transaction.CiEntityTransactionVo">
        UPDATE `cmdb_cientity_transaction`
        SET content = #{content,typeHandler=compressHandler}
        WHERE id = #{id}
    </update>

    <insert id="insertCiEntityTransaction"
            parameterType="codedriver.framework.cmdb.dto.transaction.CiEntityTransactionVo">
        INSERT INTO `cmdb_cientity_transaction` (`id`,
                                                 `ci_id`,
                                                 `ci_entity_id`,
                                                 `name`,
                                                 `action`,
                                                 `transaction_id`,
                                                 `content`,
                                                 `snapshot`,
                                                 `edit_mode`)
        VALUES (#{id},
                #{ciId},
                #{ciEntityId},
                #{name},
                #{action},
                #{transactionId},
                #{content,typeHandler=compressHandler},
                #{snapshot,typeHandler=compressHandler},
                #{editMode})
    </insert>


    <!--old-->
    <resultMap id="transactionDetailMap" type="codedriver.framework.cmdb.dto.transaction.TransactionVo">
        <id property="id" column="id"/>
        <result property="ciId" column="ciId"/>
        <result property="status" column="status"/>
        <result property="createUser" column="createUser"/>
        <result property="commitUser" column="commitUser"/>
        <result property="createUserName" column="createUserName"/>
        <result property="commitUserName" column="commitUserName"/>
        <result property="inputFrom" column="inputFrom"/>
        <result property="source" column="source"/>
        <result property="expireTime" column="expireTime"/>
        <result property="createTime" column="createTime"/>
        <result property="commitTime" column="commitTime"/>
        <result property="error" column="error"/>
        <association property="ciEntityTransactionVo"
                     javaType="codedriver.framework.cmdb.dto.transaction.CiEntityTransactionVo">
            <id property="ciEntityId" column="ciEntityId"/>
            <result property="transactionId" column="ciEntityTransactionId"/>
            <result property="ciId" column="ciId"/>
            <result property="action" column="action"/>
            <result property="editMode" column="editMode"/>
            <result property="snapshot" column="snapshot" typeHandler="compressHandler"/>
            <result property="content" column="content" typeHandler="compressHandler"/>
        </association>
    </resultMap>

    <select id="getTransactionById" parameterType="java.lang.Long" resultMap="transactionDetailMap">
        SELECT a.id,
               a.ci_id                                                   AS ciId,
               a.`status`,
               create_user                                               AS createUser,
               (SELECT user_name FROM user u WHERE u.uuid = create_user) AS createUserName,
               commit_user                                               AS commitUser,
               (SELECT user_name FROM user u WHERE u.uuid = commit_user) AS commitUserName,
               input_from                                                AS inputFrom,
               source,
               expire_time                                               AS expireTime,
               create_time                                               AS createTime,
               commit_time                                               AS commitTime,
               error,
               b.action                                                  AS action,
               b.transaction_id                                          AS ciEntityTransactionId,
               b.ci_entity_id                                            AS ciEntityId,
               b.edit_mode                                               AS editMode,
               b.snapshot                                                AS snapshot,
               b.content                                                 AS content
        FROM cmdb_transaction a
                 JOIN cmdb_cientity_transaction b
                      ON a.id = b.`transaction_id`
        WHERE a.id = #{value}
    </select>

    <sql id="searchTransactionCondition">
        <where>
            <if test="ciEntityId != null">
                AND b.`ci_entity_id` = #{ciEntityId}
            </if>
            <if test="ciId != null">
                AND a.ci_id = #{ciId}
            </if>
            <if test="status != null and status != ''">
                AND a.status = #{status}
            </if>
        </where>
    </sql>

    <select id="searchTransaction" parameterType="codedriver.framework.cmdb.dto.transaction.TransactionVo"
            resultMap="transactionDetailMap">
        SELECT
        a.id,
        a.ci_id AS ciId,
        a.`status`,
        create_user AS createUser,
        (SELECT user_name FROM user u WHERE u.uuid = create_user) AS createUserName,
        commit_user AS commitUser,
        (SELECT user_name FROM user u WHERE u.uuid = commit_user) AS commitUserName,
        input_from AS inputFrom,
        source,
        expire_time AS expireTime,
        create_time AS createTime,
        commit_time AS commitTime,
        error,
        b.action AS action,
        b.ci_entity_id AS ciEntityId,
        b.transaction_id AS ciEntityTransactionId,
        b.snapshot,
        b.content
        FROM
        cmdb_transaction a
        JOIN cmdb_cientity_transaction b
        ON a.id = b.`transaction_id`
        <include refid="searchTransactionCondition"></include>
        ORDER BY a.id DESC
        <if test="needPage == true">
            LIMIT #{startNum}, #{pageSize}
        </if>
    </select>

    <select id="searchTransactionCount" parameterType="codedriver.framework.cmdb.dto.transaction.TransactionVo"
            resultType="int">
        SELECT
        COUNT(1)
        FROM
        cmdb_transaction a
        JOIN cmdb_cientity_transaction b
        ON a.id = b.`transaction_id`
        <include refid="searchTransactionCondition"></include>
    </select>

    <resultMap id="attrEntityTransactionMap" type="codedriver.framework.cmdb.dto.transaction.AttrEntityTransactionVo">
        <id property="attrId" column="attrId"/>
        <result property="ciEntityId" column="ciEntityId"/>
        <result property="attrLabel" column="attrLabel"/>
        <result property="attrName" column="attrName"/>
        <collection property="valueList" ofType="java.lang.String">
            <result column="valueHash"/>
        </collection>
    </resultMap>

    <select id="getRelEntityTransactionByTransactionIdAndCiEntityId"
            resultType="codedriver.framework.cmdb.dto.transaction.RelEntityTransactionVo">
        SELECT a.`id`,
               a.`rel_id`                               AS relId,
               a.`transaction_id`                       AS transactionId,
               b.`id`                                   AS fromCiEntityId,
               c.`id`                                   AS toCiEntityId,
               a.`action`,
               IFNULL(b.`name`, a.`from_cientity_name`) AS fromCiEntityName,
               IFNULL(c.`name`, a.`to_cientity_name`)   AS toCiEntityName,
               d.`from_ci_id`                           AS fromCiId,
               d.`to_ci_id`                             AS toCiId,
               d.`to_label`                             AS toLabel,
               d.`from_label`                           AS fromLabel,
               d.`type_id`                              AS typeId,
               'from'                                   AS direction
        FROM `cmdb_relentity_transaction` a
                 LEFT JOIN `cmdb_cientity` b ON a.`from_cientity_id` = b.`id`
                 LEFT JOIN `cmdb_cientity` c ON a.`to_cientity_id` = c.`id`
                 LEFT JOIN `cmdb_rel` d ON a.rel_id = d.id
        WHERE a.from_cientity_id = #{ciEntityId}
          AND a.`transaction_id` = #{transactionId}
        UNION
        SELECT a.`id`,
               a.`rel_id`                               AS relId,
               a.`transaction_id`                       AS transactionId,
               b.`id`                                   AS fromCiEntityId,
               c.`id`                                   AS toCiEntityId,
               a.`action`,
               IFNULL(b.`name`, a.`from_cientity_name`) AS fromCiEntityName,
               IFNULL(c.`name`, a.`to_cientity_name`)   AS toCiEntityName,
               d.`from_ci_id`                           AS fromCiId,
               d.`to_ci_id`                             AS toCiId,
               d.`to_label`                             AS toLabel,
               d.`from_label`                           AS fromLabel,
               d.`type_id`                              AS typeId,
               'to'                                     AS direction
        FROM `cmdb_relentity_transaction` a
                 LEFT JOIN `cmdb_cientity` b ON a.`from_cientity_id` = b.`id`
                 LEFT JOIN `cmdb_cientity` c ON a.`to_cientity_id` = c.`id`
                 LEFT JOIN `cmdb_rel` d ON a.rel_id = d.id
        WHERE a.to_cientity_id = #{ciEntityId}
          AND a.`transaction_id` = #{transactionId}
        ORDER BY id
    </select>


    <select id="getAttrEntityTransactionByTransactionIdAndCiEntityId" resultMap="attrEntityTransactionMap">
        SELECT a.`id`,
               a.`ci_entity_id`   AS ciEntityId,
               a.`attr_id`        AS attrId,
               a.`attr_name`      AS attrName,
               a.`value_hash`     as valueHash,
               a.`transaction_id` AS transactionId,
               a.`savemode`       AS saveMode,
               b.label            AS attrLabel,
               c.id               AS propId,
               c.handler          AS propHandler
        FROM `cmdb_attrentity_transaction` a
                 LEFT JOIN `cmdb_attr` b ON a.attr_id = b.id
                 LEFT JOIN `cmdb_prop` c ON b.`prop_id` = c.`id`
        WHERE transaction_id = #{transactionId}
          AND ci_entity_id = #{ciEntityId}
        ORDER BY id
    </select>

    <select id="getCiEntityTransactionByTransactionGroupIdAndCiEntityId"
            resultType="codedriver.framework.cmdb.dto.transaction.CiEntityTransactionVo">
        SELECT a.`id`,
               a.`ci_id`          AS ciId,
               a.`ci_entity_id`   AS ciEntityId,
               a.`name`           AS `name`,
               a.`action`,
               a.`transaction_id` AS transactionId,
               a.`snapshot`       AS `snapshot`,
               a.`content`        AS content
        FROM `cmdb_cientity_transaction` a
                 JOIN `cmdb_transactiongroup` b ON a.transaction_id = b.transaction_id
        WHERE b.id = #{transactionGroupId}
          AND a.ci_entity_id = #{ciEntityId}
    </select>

    <select id="getCiEntityTransactionByTransactionIdAndCiEntityId"
            resultType="codedriver.framework.cmdb.dto.transaction.CiEntityTransactionVo">
        SELECT `id`,
               `ci_id`          AS ciId,
               `ci_entity_id`   AS ciEntityId,
               `name`           AS name,
               `action`,
               `transaction_id` AS transactionId,
               `snapshot`       AS snapshot,
               `content`        AS content
        FROM `cmdb_cientity_transaction`
        WHERE transaction_id = #{transactionId}
          AND ci_entity_id = #{ciEntityId}
    </select>

    <update id="updateTransactionStatus" parameterType="codedriver.framework.cmdb.dto.transaction.TransactionVo">
        UPDATE
            `cmdb_transaction`
        SET `status`      = #{status},
            `commit_time` = NOW(3),
            `commit_user` = #{commitUser},
            `error`       = #{error}
        WHERE `id` = #{id}
    </update>

    <insert id="insertTransactionGroup">
        INSERT INTO cmdb_transactiongroup
            (id, transaction_id)
        VALUES (#{transactionGroupId},
                #{transactionId})
    </insert>

    <insert id="insertRelEntityTransaction"
            parameterType="codedriver.framework.cmdb.dto.transaction.RelEntityTransactionVo">
        INSERT INTO `cmdb_relentity_transaction` (`id`,
                                                  `rel_id`,
                                                  `from_cientity_id`,
                                                  `to_cientity_id`,
                                                  `from_cientity_name`,
                                                  `to_cientity_name`,
                                                  `transaction_id`,
                                                  `action`)
        VALUES (#{id},
                #{relId},
                #{fromCiEntityId},
                #{toCiEntityId},
                #{fromCiEntityName},
                #{toCiEntityName},
                #{transactionId},
                #{action})
    </insert>

    <!-- <insert id="insertAttrEntityTransaction"
             parameterType="codedriver.framework.cmdb.dto.transaction.AttrEntityTransactionVo">
         INSERT INTO `cmdb_attrentity_transaction` (
         `ci_entity_id`,
         `attr_id`,
         `attr_name`,
         `attr_label`,
         `value_hash`,
         `transaction_id`,
         `savemode`
         )
         VALUES
         <choose>
             <when test="valueHashList != null and valueHashList.size() > 0">
                 <foreach collection="valueHashList" item="item" separator=",">
                     (
                     #{ciEntityId},
                     #{attrId},
                     #{attrName},
                     #{attrLabel},
                     #{item},
                     #{transactionId},
                     #{saveMode}
                     )
                 </foreach>
             </when>
             <otherwise>
                 (
                 #{ciEntityId},
                 #{attrId},
                 #{attrName},
                 #{attrLabel},
                 '',
    #{transactionId},
    #{saveMode}
    )
</otherwise>
        </choose>
        </insert>-->


    <insert id="insertTransaction" parameterType="codedriver.framework.cmdb.dto.transaction.TransactionVo">
        INSERT INTO `cmdb_transaction` (`ci_id`,
        `id`,
        `status`,
        `create_user`,
        `input_from`,
        `source`,
        `expire_time`,
        `create_time`
        <if test="status == 'commited'">
            ,`commit_time`
        </if>)
        VALUES (#{ciId},
        #{id},
        #{status},
        #{createUser},
        #{inputFrom},
        #{source},
        #{expireTime},
        NOW(3)
        <if test="status == 'commited'">
            , NOW(3)
        </if>)
    </insert>

    <delete id="deleteTransactionByCiId" parameterType="java.lang.Long">
        DELETE
            a,b,c,d
        FROM cmdb_transaction a
                 LEFT JOIN cmdb_cientity_transaction b ON a.`id` = b.`transaction_id`
                 LEFT JOIN cmdb_attrentity_transaction c ON b.`transaction_id` = c.`transaction_id`
                 LEFT JOIN cmdb_relentity_transaction d ON b.`transaction_id` = d.`transaction_id`
                 LEFT JOIN cmdb_transactiongroup e ON a.`id` = e.`transaction_id`
        WHERE a.`ci_id` =
              #{value}
    </delete>
</mapper>
