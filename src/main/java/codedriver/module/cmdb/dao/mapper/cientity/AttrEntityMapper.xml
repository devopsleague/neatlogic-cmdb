<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.module.cmdb.dao.mapper.cientity.AttrEntityMapper">


	<!--old-->

	<resultMap id="attrEntityMap" type="codedriver.module.cmdb.dto.cientity.AttrEntityVo">
		<id property="attrId" column="attrId"/>
		<id property="ciEntityId" column="ciEntityId"/>
		<result property="transactionId" column="transactionId"/>
		<result property="attrName" column="attrName"/>
		<result property="attrLabel" column="attrLabel"/>
		<result property="attrType" column="attrType"/>
		<result property="attrExpression" column="attrExpression"/>
		<collection property="valueList" ofType="java.lang.String">
			<result column="valueHash"/>
		</collection>
	</resultMap>

	<select id="getAttrEntityByAttrIdAndValue" parameterType="codedriver.module.cmdb.dto.cientity.AttrEntityVo" resultMap="attrEntityMap">
		SELECT
		a.`id`,
		a.`ci_entity_id` AS ciEntityId,
		a.`attr_id` AS attrId,
		a.`value_hash` AS valueHash,
		b.`name` AS attrName,
		b.`label` AS attrLabel,
		b.`type` AS attrType,
		b.`expression` AS attrExpression,
		b.`prop_id` AS propId,
		p.`handler` AS propHandler
		FROM
		`cmdb_attrentity` a JOIN
		`cmdb_attr` b ON a.`attr_id` = b.`id`
		LEFT JOIN `cmdb_prop` p ON b.`prop_id` = p.id
		WHERE a.ci_entity_id != #{ciEntityId}
		AND a.attr_id = #{attrId}
		AND a.value_hash IN
		<foreach collection="valueHashList" item="item" open="(" separator="," close=")"> #{item}</foreach>
		ORDER BY a.id
	</select>

	<select id="getAttrEntityByCiEntityId" parameterType="java.lang.Long" resultMap="attrEntityMap">
		SELECT
		a.`id`,
		a.`ci_entity_id` AS ciEntityId,
		a.`attr_id` AS attrId,
		a.`value_hash` AS valueHash,
		a.`transaction_id` AS transactionId,
		b.`name` AS attrName,
		b.`label` AS attrLabel,
		b.`type` AS attrType,
		b.`expression` AS attrExpression,
		b.`prop_id` AS propId,
		p.`handler` AS propHandler
		FROM
		`cmdb_attrentity` a JOIN
		`cmdb_attr` b ON a.`attr_id` = b.`id`
		LEFT JOIN `cmdb_prop` p ON b.`prop_id` = p.id
		WHERE a.ci_entity_id = #{value}
		ORDER BY a.id
	</select>

	<select id="getAttrEntityByCiEntityIdAndAttrId" resultMap="attrEntityMap">
		SELECT
		a.`id`,
		a.`ci_entity_id` AS ciEntityId,
		a.`attr_id` AS attrId,
		a.`value_hash` AS valueHash,
		a.`transaction_id` AS transactionId,
		b.`name` AS attrName,
		b.`label` AS attrLabel,
		b.`type` AS attrType,
		b.`expression` AS attrExpression,
		b.`prop_id` AS propId,
		p.`handler` AS propHandler
		FROM
		`cmdb_attrentity` a JOIN
		`cmdb_attr` b ON a.`attr_id` = b.`id`
		LEFT JOIN `cmdb_prop` p ON b.`prop_id` = p.id
		WHERE a.ci_entity_id = #{ciEntityId} AND a.attr_id = #{attrId}
		ORDER BY a.id
	</select>

	<select id="searchAttrEntityByCiEntityIdList" resultMap="attrEntityMap">
		SELECT
		a.`id`,
		a.`ci_entity_id` AS ciEntityId,
		a.`attr_id` AS attrId,
		a.`value_hash` AS valueHash,
		a.`transaction_id` AS transactionId,
		b.`name` AS attrName,
		b.`label` AS attrLabel,
		b.`type` AS attrType,
		b.`expression` AS attrExpression,
		b.`prop_id` AS propId,
		p.`handler` AS propHandler
		FROM
		`cmdb_attrentity` a JOIN
		`cmdb_attr` b ON a.`attr_id` = b.`id`
		LEFT JOIN `cmdb_prop` p ON b.`prop_id` = p.id
		WHERE a.ci_entity_id IN
		<foreach collection="idList" item="item" open="(" separator="," close=")">
			#{item}
		</foreach>
		<if test="attrIdList != null and attrIdList.size() > 0">
			AND a.attr_id IN
			<foreach collection="attrIdList" item="item" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		ORDER BY
		a.id
	</select>


	<insert id="insertAttrEntity" parameterType="codedriver.module.cmdb.dto.cientity.AttrEntityVo">
		INSERT INTO `cmdb_attrentity` (
		`ci_entity_id`,
		`attr_id`,
		`attr_name`,
		`value_hash`,
		`transaction_id`
		)
		VALUES
		<foreach collection="valueHashList" item="item" separator=",">
			(
			#{ciEntityId},
			#{attrId},
			#{attrName},
			#{item},
			#{transactionId}
			)
		</foreach>
	</insert>

	<delete id="deleteAttrEntity" parameterType="codedriver.module.cmdb.dto.cientity.AttrEntityVo">
		DELETE
		FROM
		`cmdb_attrentity`
		WHERE ci_entity_id = #{ciEntityId}
		AND attr_id = #{attrId}
	</delete>


</mapper>
